<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modular Web Scraper</title>
<!-- Include Bootstrap CSS for cleaner and more professional styling -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-light">

<!-- Navbar with Login, Register, and Logout Links -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Modular Web Scraper</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                {% if current_user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link" href="/logout">Logout</a>
                </li>
                {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="/login">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/register">Register</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h1 class="text-center mb-4">Select a Module and Search</h1>

    <form id="searchForm" class="d-flex justify-content-center">
        <div class="row w-75">
            <!-- Module Selection Dropdown -->
            <div class="col-md-4 mb-3">
                <label for="module" class="form-label">Select Module:</label>
                <select name="module" id="module" class="form-select">
                    {% for module_name in module_names %}
                    <option value="{{ module_name }}">{{ module_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Search Query Input -->
            <div class="col-md-6 mb-3">
                <label for="query" class="form-label">Search Query:</label>
                <input type="text" id="query" name="query" class="form-control" placeholder="Enter anime title" required>
            </div>

            <!-- Buttons for Search, Home, and My List -->
            <div class="col-md-2 mb-3">
                <button type="submit" class="btn btn-primary w-100 mb-2">Search</button>
                <button type="button" class="btn btn-secondary w-100 mb-2" onclick="goHome()">Home</button>
                <button type="button" class="btn btn-info w-100" onclick="toggleMyList()">My List</button>
            </div>
        </div>
    </form>

    <!-- Search Results Section -->
    <div id="results" class="mt-4"></div>

    <!-- My List Sidebar -->
    <div id="myListSidebar" class="bg-light border p-4" style="display: none; position: fixed; right: 0; top: 0; width: 300px; height: 100%; overflow-y: scroll;">
        <h2>My List</h2>
        <div id="myListContent"></div>
    </div>
</div>

<script>
    // Your existing JavaScript code for search, add to list, remove from list, etc.
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();

        let module = document.getElementById('module').value;
        let query = document.getElementById('query').value;

        fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `module=${module}&query=${query}`
        })
        .then(response => response.json())
        .then(data => {
            let resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = ''; // Clear previous results

            if (data.error) {
                resultsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
            } else {
                data.data.forEach(item => {
                    resultsDiv.innerHTML += `
                        <div>
                            <img src="${item.image}" alt="${item.title}" width="100">
                            <h3>${item.title}</h3>
                            <!-- Watch Now Button redirects to /watch -->
                            <button onclick="window.location.href='/watch?title=${encodeURIComponent(item.title)}&link=${encodeURIComponent(item.link)}'">Watch Now</button>
                            <button onclick="addToMyList('${item.title}', '${item.image}', '${item.link}', '${module}')">Add to My List</button>
                        </div>
                        <hr>
                    `;
                });
            }
        })
        .catch(err => {
            console.error('Error:', err);
        });
    });

    function addToMyList(title, image, link) {
        fetch('/add_to_list', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ title, image, link})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const myListContent = document.getElementById('myListContent');
                const newIndex = myListContent.children.length;

                myListContent.innerHTML += `
                    <div id="list-item-${newIndex}">
                        <img src="${image}" alt="${title}" width="100">
                        <h3>${title}</h3>
                        <button onclick="window.location.href='/watch?title=${encodeURIComponent(title)}&link=${encodeURIComponent(link)}'">Watch Now</button>
                        <button onclick="removeFromMyList(${newIndex})">Remove</button>
                    </div>
                    <hr>
                `;
            }
        })
        .catch(err => {
            console.error('Error:', err);
        });
    }

    function toggleMyList() {
    const sidebar = document.getElementById('myListSidebar');
    const isVisible = sidebar.style.display === 'block';
    sidebar.style.display = isVisible ? 'none' : 'block';

    // Fetch the list from the server
    if (!isVisible) {
        fetch('/my_list')
        .then(response => response.json())
        .then(data => {
            displayList(data.my_list);  // Pass the fetched data to the display function
        })
        .catch(err => {
            console.error('Error fetching My List:', err);
        });
    }
}

function displayList(list) {
    let myListContent = document.getElementById('myListContent');
    myListContent.innerHTML = '';  // Clear previous content

    if (list.length === 0) {
        myListContent.innerHTML = '<p>No anime in your list.</p>';
    } else {
        list.forEach((item) => {
            myListContent.innerHTML += `
                <div id="list-item-${item.id}">
                    <img src="${item.image}" alt="${item.title}" width="100">
                    <h3>${item.title}</h3>
                    <button onclick="window.location.href='/watch?title=${encodeURIComponent(item.title)}&link=${encodeURIComponent(item.link)}'">Watch Now</button>
                    <button onclick="removeFromMyList(${item.id})">Remove</button>
                </div>
                <hr>
            `;
        });
    }
}


    function removeFromMyList(animeId) {
    fetch('/remove_from_list', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: animeId })  // Pass the actual ID of the anime
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the item from the DOM immediately
            document.getElementById(`list-item-${animeId}`).remove();
        } else {
            console.error('Error:', data.error);
        }
    })
    .catch(err => {
        console.error('Error:', err);
    });
}

</script>

</body>
</html>
